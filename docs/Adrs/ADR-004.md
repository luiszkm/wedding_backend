ADR-004: Refatoração do Contexto de Lista de Presentes para Suportar Presentes Fracionados (Cotas)
Status: Aceito

Data: 2025-08-06

1. Contexto (Context)
O sistema atual suporta apenas a seleção de presentes "integrais", onde um convidado seleciona um item por completo. Esta abordagem limita o valor dos presentes que os anfitriões podem realisticamente pedir e restringe a capacidade dos convidados de contribuírem para itens mais caros.

Para aumentar o valor da plataforma, alinhá-la com as práticas de mercado de registros de presentes e abrir novas possibilidades de monetização, surgiu a necessidade de permitir que presentes de alto valor sejam divididos em "cotas" de valor menor, que podem ser selecionadas individualmente por múltiplos convidados.

A decisão arquitetural consiste em como modificar o Contexto de Lista de Presentes para acomodar esta nova e complexa lógica de negócio de forma robusta, segura e manutenível, sem perturbar os outros contextos do sistema.

2. Decisão (Decision)
Decidimos por uma refatoração profunda do domínio Lista de Presentes, enriquecendo o agregado Presente para gerenciar internamente o conceito de Cotas. A transação de seleção será atualizada para lidar tanto com presentes integrais quanto com a seleção de uma ou mais cotas de um presente fracionado.

O plano de implementação detalhado é:

Refatoração do Agregado Presente:

O Presente permanecerá como a Raiz do Agregado, mas será modificado para:

Conter um novo campo tipo (INTEGRAL ou FRACIONADO).

Ter um status expandido para incluir PARCIALMENTE_SELECIONADO.

Para o tipo FRACIONADO, ele conterá uma lista de entidades Cota.

A lógica de negócio para selecionar cotas (verificar disponibilidade, marcar como selecionada, atualizar o status geral do presente) será encapsulada dentro de métodos no próprio agregado Presente, garantindo a consistência de seus dados internos.

Introdução da Entidade Cota:

Uma nova entidade Cota será criada para representar uma única "fatia" de um presente fracionado. Ela existirá apenas dentro do agregado Presente e terá seu próprio status (DISPONIVEL, SELECIONADA) e valor.

Alterações no Esquema de Banco de Dados:

A tabela presentes será alterada para incluir as colunas tipo (ex: VARCHAR) e valor_total_presente (ex: NUMERIC). O ENUM de status será atualizado.

Uma nova tabela, cotas_de_presentes, será criada. Cada linha representará uma cota individual, contendo seu valor, status, e uma chave estrangeira (id_presente) para o presente ao qual pertence.

Atualização da API:

Criação (Admin): O endpoint POST /eventos/{idEvento}/presentes será modificado para aceitar um DTO que permita a criação de presentes do tipo FRACIONADO, especificando o valorTotal e o numeroDeCotas.

Leitura (Convidado): O endpoint GET /eventos/{idEvento}/presentes-publico retornará um DTO de presente enriquecido, que, para itens fracionados, incluirá informações como valorCota, cotasTotais e cotasDisponiveis.

Seleção (Convidado): O endpoint POST /selecoes-de-presente será alterado para aceitar uma lista de "itens", onde cada item especifica um idPresente e uma quantidade. Para um presente integral, a quantidade será 1. Para um fracionado, será o número de cotas que o convidado deseja selecionar.

3. Consequências (Consequences)
Positivas:

Aumento do Valor Estratégico do Produto: Posiciona a plataforma como uma solução de registro de presentes completa e competitiva, abrindo portas para modelos de negócio diretos (taxas de serviço).

Melhora da Experiência do Usuário: Anfitriões podem pedir itens mais significativos, e convidados podem participar de presentes caros de forma inclusiva e de acordo com seu orçamento.

Complexidade Contida: Apesar da alta complexidade da feature, o design a isola quase que inteiramente dentro do Contexto de Lista de Presentes, preservando o baixo acoplamento da arquitetura geral.

Modelo de Domínio mais Rico: O domínio se torna uma representação mais fiel e poderosa do problema do mundo real, capaz de suportar regras de negócio mais sofisticadas.

Negativas:

Aumento Significativo da Complexidade Técnica: A lógica de negócio, as transações e o esquema de banco de dados dentro do Contexto de Lista de Presentes se tornam substancialmente mais complexos.

Maior Risco de Implementação: A refatoração é não-trivial e exige testes rigorosos, especialmente na lógica transacional, para evitar bugs como a venda dupla de uma mesma cota.

Potencial Impacto na Performance: As consultas para exibir a lista de presentes podem se tornar mais pesadas, exigindo agregações para calcular o número de cotas disponíveis. Isso deve ser monitorado e otimizado.